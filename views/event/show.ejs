<% layout('layouts/boilerplate') -%>
<div class="py-3">
  <div class="card shadow">
    <!-- Event Image -->
    <img
      src="<%= event.image.url %>"
      class="card-img-top"
      alt="Event Image"
      style="height: 300px; object-fit: cover"
    />
    <div class="card-body">
      <!-- Title -->
      <h2 class="card-title"><%= event.title %></h2> 

      <p class="text-muted mb-1">
       <i class="fa-solid fa-location-dot"></i> <%= event.location %>
      </p>

      <!-- Date and Time -->
      <p class="text-muted mb-1">
        <i class="fa-regular fa-calendar"></i>
        <%= new Date(event.date).toLocaleDateString("en-US", { year: "numeric",
        month: "long", day: "numeric" }) %>
      </p>

    <%
    // Create fake full date
  const fullTime = new Date(`1970-01-01T${event.time}`);
%>
<p class="text-muted mb-3">
  <i class="fa-regular fa-clock"></i>
   <%= fullTime.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) %>
</p>

      <!-- Full Description -->
      <h5 class="h5-showPage" >Description:</h5>
      <p class="card-text"><%= event.description %></p>
      <% const seatsLeft = event.maxAttendees - event.attendees.length; %>
 <%
const now = new Date();
const eventDate = new Date(event.date);
const [hours, minutes] = event.time.split(":").map(Number);
const timezoneOffset = event.timezoneOffset || 0;
const eventDateTime = new Date(Date.UTC(
  eventDate.getFullYear(),
  eventDate.getMonth(),
  eventDate.getDate(),
  hours,
  minutes + timezoneOffset, 
  0, // seconds
  0  // milliseconds
));
%>

      <!-- Seats Availability -->
        <% if (eventDateTime.getTime() > now.getTime()) { %>
      <p class="text-info fw-bold">
  <i class="bi bi-person-check-fill"></i>
  Seats Available:
  <span class="<%= seatsLeft === 0 ? 'text-danger' : 'text-success' %>">
    <%= seatsLeft %>
  </span>
</p>
      <!-- Book Event Section -->
      
      <h5 class=" text-success h5-showPage">
        <i class="bi bi-ticket-perforated"></i> Book This Event
      </h5>
<% } %>
      <!-- Buttons (Grouped) -->
      <div class="d-flex gap-2 flex-wrap mt-3 ">

        <% if (eventDateTime.getTime() > now.getTime()) { %>
        <form action="/events/<%= event._id %>/bookings" method="POST">
          <button
            type="submit"
            class="btn <%= seatsLeft === 0 || hasbook ? 'btn-secondary secondary-btn' : 'btn-success primary-btn' %>"
            <%= seatsLeft === 0 ||hasbook ? 'disabled' : '' %>
            > <i class="bi bi-check-circle"></i> <%= seatsLeft === 0 ? "No Seats Left" : hasbook ? "Booked" : "Book Event" %>
          </button>
        </form>
        <!-- For Unbooking -->
        <form
          action="/events/<%= event._id %>/bookings?_method=DELETE"
          method="POST"
        >
         <button
  type="submit"
  class="btn <%= hasbook ? 'btn-success primary-btn' : 'btn-secondary secondary-btn' %>"
  <%= hasbook ? '' : 'disabled' %>
>
  <i class="bi bi-x-circle"></i>
  <%= hasbook ? "UnBook Event" : "Not Booked" %>
</button>

        </form>
        <% } else { %>
          <div class="text-danger">
    <i class="bi bi-calendar-x-fill"></i>
    This event has expired. Bookings are now closed.
  </div>
          <% } %>

    <!-- Responsive line break for small screens -->
  <div class="w-100 d-md-none"></div>

        <% if(currUser && currUser._id.equals(event.owner._id)){ %>
        <a href="/events/<%= event._id %>/edit" class="btn primary-btn ms-md-auto">
          <i class="bi bi-pencil-square"></i> Edit
        </a>

        <form action="/events/<%= event._id %>?_method=DELETE" method="POST">
          <button
            type="submit"
            class="btn btn-danger"
            onclick="return confirm('Are you sure you want to delete this event?')"
          >
            <i class="bi bi-trash"></i> Delete
          </button>
        </form>
        <% } %>
      </div>

      <% if (currUser && currUser._id.equals(event.owner._id)) { %>
      <div class="mt-4 w-100">
        <h5 class="h5-showPage" ><i class="bi bi-people-fill"></i> Booked Attendees</h5>

        <!-- Toggle Button -->
        <button
          class="btn btn-outline-primary primary-outline-btn mb-2"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#attendeesCollapse"
          aria-expanded="false"
          aria-controls="attendeesCollapse"
        >
          <i class="bi bi-eye-fill"></i> View Attendees
        </button>

        <!-- Collapsible Section -->
        <div class="collapse" id="attendeesCollapse">
          <% if (event.attendees.length === 0) { %>
          <p class="text-muted">No one has booked this event yet.</p>
          <% } else { %>
          <!-- This heading shows only when the collapse is open...  -->
          <h6 class="mb-2 text-success">
            <i class="bi bi-check-circle-fill"></i>
            These users have booked this event:
          </h6>

          <ul class="list-group">
            <% event.attendees.forEach(att => { %>
            <li class="list-group-item">
              <i class="bi bi-person-circle"></i> <%= att.email %>
            </li>
            <% }) %>
          </ul>
          <% } %>
        </div>
      </div>
      <% } %>
    </div>
  </div>

</div>
